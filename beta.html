<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAO Tensor Law — Bittensor Price Model — by decodejar</title>
    
    <!-- ===== FAVICON TAGS ===== -->
    <link rel="icon" href="/decode-favicon.png" type="image/png">
    <link rel="shortcut icon" href="/decode-favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/decode-favicon.png">
    <!-- ===== END FAVICON TAGS ===== -->    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXV4MXZNHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-EXV4MXZNHJ');
    </script>    

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Importing Inter, Courgette, and JetBrains Mono -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Courgette&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration for Custom Fonts/Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        handwriting: ['Courgette', 'cursive'],
                        mono: ['JetBrains Mono', 'monospace'], 
                    },
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom deep slate
                        }
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'inner-light': 'inset 0 2px 4px 0 rgba(255, 255, 255, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Internal Styles -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            /* RESTORED: Blue-themed gradient background */
            background-color: #f1f5f9; /* slate-100 */
            background-image: radial-gradient(at 0% 0%, hsla(215,30%,15%,0) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(200,50%,25%,0) 0, transparent 50%);
        }
        
        /* Loader animation */
        .loader {
            border: 3px solid rgba(226, 232, 240, 0.3); /* slate-200 equivalent */
            border-left-color: #2563eb; /* blue-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Colored status dot */
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- Fullscreen CSS Logic --- */
        
        body:has(#mainContainer:fullscreen) { display: block; background: white; }

        #mainContainer:fullscreen {
            width: 100vw;
            height: 100vh;
            max-width: none !important;
            border-radius: 0 !important;
            border: none !important;
            display: flex;
            flex-direction: column;
            padding: 0 !important;
            background: white;
        }

        #mainContainer:fullscreen #chartCard {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-shadow: none !important;
            border: none !important;
            background: transparent !important;
        }

        #mainContainer:fullscreen #chartWrapper {
            height: 100% !important;
            flex-grow: 1;
        }

        body:has(#mainContainer:fullscreen) footer { display: none; }

        /* --- Mobile Fullscreen Optimizations --- */
        @media (max-width: 639px) and (orientation: portrait) {
            #mainContainer:fullscreen #rotateOverlay { display: flex !important; }
            #mainContainer:fullscreen header,
            #mainContainer:fullscreen #topStatusBar,
            #mainContainer:fullscreen #chartCard,
            #mainContainer:fullscreen #bottomModelBar,
            #mainContainer:fullscreen #fullscreenBtn { display: none !important; }
        }

        #mainContainer.mobile-fullscreen-landscape {
             /* Reset container padding to 0 so bars span full width */
             padding: 0 !important;
        }
        
        #mainContainer.mobile-fullscreen-landscape #bottomModelBar { display: none !important; }
        
        /* Only zeroing vertical padding to maximize space. */
        #mainContainer.mobile-fullscreen-landscape #chartCard { 
            padding-top: 0 !important;
            padding-bottom: 0.25rem !important; 
        }
        
        /* Header Adjustments for Mobile Landscape Fullscreen */
        #mainContainer.mobile-fullscreen-landscape header {
             height: 2.5rem !important; /* Keep slightly compact */
             margin-bottom: 0 !important; /* Remove gap (extra line) */
        }
        #mainContainer.mobile-fullscreen-landscape header h1 { font-size: 1.125rem !important; }
        #mainContainer.mobile-fullscreen-landscape header img { width: 1.75rem !important; height: 1.75rem !important; }
        #mainContainer.mobile-fullscreen-landscape #fullscreenBtn svg { width: 1.25rem !important; height: 1.25rem !important; }
        #mainContainer.mobile-fullscreen-landscape #headerLinkWrapper {
             font-size: 0.75rem !important;
             line-height: 1rem !important;
        }
        #mainContainer.mobile-fullscreen-landscape #headerLinkWrapper a:first-of-type,
        #mainContainer.mobile-fullscreen-landscape #headerLinkWrapper span { display: none !important; }

        /* Top Status Bar Adjustments for Mobile Landscape Fullscreen */
        /* Forces the "step down" size (text-xs / py-2) regardless of screen resolution */
        #mainContainer.mobile-fullscreen-landscape #topStatusBar {
             padding-top: 0.4rem !important;
             padding-bottom: 0.4rem !important;
        }
        #mainContainer.mobile-fullscreen-landscape #topStatusBar,
        #mainContainer.mobile-fullscreen-landscape #topStatusBar * {
             font-size: 0.75rem !important; /* text-xs */
             line-height: 1rem !important;
        }
        
        /* --- Projection & Band Table Styles --- */
        #projectionTable,
        #bandLevelsTable {
            position: absolute;
            top: 12%;
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
            line-height: 1.4; 
            color: #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.6);
            width: max-content;
            transition: box-shadow 0.2s ease;
        }
        
        #projectionTable:hover,
        #bandLevelsTable:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        #projectionTable { left: 5%; }
        #bandLevelsTable { left: 5%; }

        #projectionTable h3,
        #bandLevelsTable h3 {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid rgba(203, 213, 225, 0.5);
            padding-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            user-select: none;
            letter-spacing: -0.02em;
        }
        
        #projectionTable h3:active,
        #bandLevelsTable h3:active {
            cursor: grabbing;
        }

        #projectionData > div,
        #bandLevelsTable > div > div {
            display: flex;
            justify-content: space-between;
            padding: 1px 0; 
            gap: 2rem; 
        }

        #projectionData > div span:first-child,
        #bandLevelsTable > div > div span:first-child {
            color: #64748b;
            font-weight: 500;
        }
        
        #projectionData > div span:last-child,
        #bandLevelsTable > div > div span:last-child {
            font-family: 'JetBrains Mono', monospace; 
            font-weight: 500;
            color: #0f172a;
            text-align: right;
        }
        
        #projectionTable h3 button,
        #bandLevelsTable h3 button {
            margin-left: 0.75rem;
            color: #94a3b8;
            cursor: pointer;
            background: none;
            border: none;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        #projectionTable h3 button:hover,
        #bandLevelsTable h3 button:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
    </style>
</head>
<body class="text-slate-800 flex flex-col items-center h-screen p-3 sm:p-4 md:p-6 overflow-hidden bg-slate-200">

    <!-- SEO text -->
    <div class="sr-only">
        TAO Tensor Law is a Bittensor price model. This interactive chart models the price history of TAO against a logarithmic power law regression (Price = C * (Time + Offset)^α). With an optimal time offset for best fit, it calculates the 'fair value' trend line and price rating bands (discount, value, expensive, bubble) to help visualize TAO's historical valuation. The tool includes features to toggle bands, pan, zoom, and see future price projections based on this long-term model. The TAO Tensor Law Model was created by decodejar (decodejar.com, x.com/decodejar).
    </div>

    <!-- Main application container -->
    <div id="mainContainer" class="w-full flex-grow max-w-[1920px] max-h-[1080px] min-h-[30rem] flex flex-col bg-white/80 backdrop-blur-xl rounded-2xl border border-white/50 shadow-2xl shadow-slate-400/30 relative overflow-hidden transition-all duration-300">

        <!-- Mobile Rotate Overlay -->
        <div id="rotateOverlay" class="hidden absolute inset-0 w-full h-full bg-white/95 z-50 flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-blue-500 mb-4 animate-pulse">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Please Rotate Device</h2>
            <p class="text-slate-500">This chart is optimized for landscape mode.</p>
        </div>

        <!-- Page Header -->
        <header class="relative h-14 sm:h-16 flex items-center justify-between px-4 sm:px-6 border-b border-slate-100 bg-white z-50">
            <!-- Left: Logo/Links -->
            <div class="flex items-center">
                <a href="https://decodejar.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 group">
                    <!-- Logo -->
                    <div class="rounded-full group-hover:scale-105 transition-transform duration-300">
                        <img src="decode.png" alt="decodejar" class="w-8 h-8 rounded-full bg-white border-2 border-white" onerror="this.src='https://placehold.co/40x40/eeeeee/333333?text=D'; this.onerror=null;">
                    </div>
                    <!-- Text -->
                    <span class="hidden sm:block font-sans font-bold text-black text-lg tracking-tight group-hover:text-blue-600 transition-colors">decodejar</span>
                </a>
            </div>

            <!-- Center: Title -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-2">
                <h1 class="text-lg sm:text-xl md:text-2xl font-semibold text-black tracking-tight whitespace-nowrap">
                    TAO Tensor Law
                    <span class="hidden md:inline ml-1 text-lg text-slate-400 font-handwriting font-normal text-blue-500/80">Bittensor Price Model</span>
                </h1>
                <!-- Tooltip -->
                <div class="group relative flex items-center">
                      <span class="text-[10px] font-bold text-slate-400 cursor-help border border-slate-300 rounded-full w-4 h-4 flex items-center justify-center hover:bg-slate-100 hover:text-blue-500 transition-colors">?</span>
                      <div class="absolute top-6 left-1/2 -translate-x-1/2 w-72 bg-slate-800 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 shadow-xl z-50 font-light leading-relaxed">
                        TAO Tensor Law is a Bittensor price model. This interactive chart models the price history of TAO against a logarithmic power law regression (Price = C * (Time + Offset)^α). With an optimal time offset for best fit, it calculates the 'fair value' trend line and price rating bands (discount, value, expensive, bubble) to help visualize TAO's historical valuation. The tool includes features to toggle bands, pan, zoom, and see future price projections based on this long-term model. The TAO Tensor Law Model was created by decodejar (decodejar.com, x.com/decodejar).
                      </div>
                </div>
            </div>

             <!-- Right: Fullscreen -->
            <button id="fullscreenBtn" onclick="toggleFullScreen()" class="text-slate-400 hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-slate-50" title="Toggle Fullscreen">
                <svg id="fsIconEnter" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m4.5 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                </svg>
                <svg id="fsIconExit" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 hidden">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 9L3.75 3.75M9 9h4.5m-4.5 0v4.5m0-4.5L3.75 3.75M9 15l-5.25 5.25M9 15h4.5m-4.5 0v-4.5m0 4.5l-5.25 5.25M15 9l5.25-5.25M15 9h-4.5m4.5 0v4.5m0-4.5l5.25-5.25M15 15l5.25 5.25M15 15h-4.5m4.5 0v-4.5m0 4.5l5.25 5.25" />
                </svg>
            </button>
        </header>

        <!-- Top Status Bar -->
        <div id="topStatusBar" class="flex flex-wrap items-center justify-center sm:justify-between gap-x-4 gap-y-2 px-4 sm:px-6 py-2 md:py-3 border-b border-slate-100 bg-slate-50">
             <!-- Left Group: Price & Status -->
             <div class="flex items-center gap-6 text-xs md:text-sm font-medium text-slate-600">
                 <!-- Price (First) -->
                 <div id="lastPriceDiv" class="hidden sm:flex items-center text-slate-700"></div>
                 <!-- Data Status (Second) -->
                 <div id="dataStatusDiv" class="flex items-center bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm">
                     <span class="status-dot bg-slate-200 animate-pulse"></span><span class="text-slate-400">Loading...</span>
                 </div>
             </div>
             
             <!-- Right Group: Rating & Toggle -->
             <div class="flex items-center gap-4 text-xs md:text-sm">
                 <!-- Zone -->
                 <div id="priceZoneDiv" class="hidden sm:flex items-center bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm"></div>

                 <!-- Bands Toggle -->
                 <div id="showBandsContainer" class="flex items-center hidden group">
                     <label for="showBandsCheckbox" class="flex items-center cursor-pointer select-none">
                          <span class="mr-3 text-xs md:text-sm font-medium text-slate-700 group-hover:text-blue-600 transition-colors">Show Bands</span>
                          <div class="relative">
                             <input type="checkbox" id="showBandsCheckbox" class="peer sr-only">
                             <div class="block h-6 w-10 rounded-full bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 transition-colors peer-checked:bg-blue-500"></div>
                             <div class="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition-transform peer-checked:translate-x-4"></div>
                          </div>
                     </label>
                 </div>
             </div>
        </div>

        <!-- Chart Area -->
        <div id="chartCard" class="relative flex-grow min-h-0 w-full px-4 sm:px-6 pb-4 bg-white">
            <!-- Loading Spinner -->
            <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col gap-3 items-center justify-center z-30 transition-opacity duration-300">
                <div class="loader"></div>
                <p class="text-xs text-slate-400 animate-pulse uppercase tracking-widest">Initializing Model</p>
            </div>
            
            <!-- Canvas Wrapper -->
            <div id="chartWrapper" class="relative w-full h-full bg-white">
                
                <!-- Draggable Tables -->
                <div id="projectionTable" class="hidden transform transition-transform active:scale-[1.02]">
                    <h3 id="projectionHeader">
                        <span>Fair Value</span>
                        <button onclick="document.getElementById('projectionTable').style.display='none'" type="button" title="Close">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </h3>
                    <div id="projectionData" class="flex flex-col pt-1"></div>
                </div>

                <div id="bandLevelsTable" class="hidden transform transition-transform active:scale-[1.02]">
                    <h3 id="bandsHeader">
                        <span>Valuation Bands</span>
                        <button onclick="document.getElementById('bandLevelsTable').style.display='none'" type="button" title="Close">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </h3>
                    <div class="flex flex-col pt-1">
                        <div id="bandLevelBubble">
                            <span class="inline-flex items-center text-xs"><span class="w-2 h-2 rounded-full bg-red-400 mr-2 shadow-sm"></span>Bubble</span>
                            <span class="whitespace-nowrap text-slate-700 font-mono">$N/A</span>
                        </div>
                        <div id="bandLevelExpensive">
                            <span class="inline-flex items-center text-xs"><span class="w-2 h-2 rounded-full bg-yellow-400 mr-2 shadow-sm"></span>Expensive</span>
                            <span class="whitespace-nowrap text-slate-700 font-mono">$N/A</span>
                        </div>
                        <div id="bandLevelValue">
                            <span class="inline-flex items-center text-xs"><span class="w-2 h-2 rounded-full bg-green-500 mr-2 shadow-sm"></span>Value</span>
                            <span class="whitespace-nowrap text-slate-700 font-mono">$N/A</span>
                        </div>
                        <div id="bandLevelDiscount">
                            <span class="inline-flex items-center text-xs"><span class="w-2 h-2 rounded-full bg-blue-400 mr-2 shadow-sm"></span>Discount</span>
                            <span class="whitespace-nowrap text-slate-700 font-mono">$N/A</span>
                        </div>
                    </div>
                </div>
                
                <!-- The Canvas -->
                <canvas id="powerLawChart"></canvas>
            </div>
        </div>

        <!-- Bottom Model Info Bar -->
        <div id="bottomModelBar" class="bg-slate-50 border-t border-slate-100 px-4 sm:px-6 py-2 md:py-3 flex flex-wrap items-center justify-center gap-x-6 gap-y-2 text-xs md:text-sm font-medium text-slate-500">
            <!-- Order: Offset, Toggle, Exponent, Fit -->
            <div id="modelParamDiv" class="text-slate-600"></div>
            
            <!-- Model Toggle Switch (New Segmented Control) -->
            <div class="flex items-center bg-slate-200 rounded-lg p-1 gap-1 select-none" id="offsetControl">
                <button class="px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50" onclick="setOffsetMode('74')" id="btn-74">74</button>
                <button class="px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold transition-all text-slate-500 hover:text-slate-700 hover:bg-white/50" onclick="setOffsetMode('232')" id="btn-232">232</button>
                <button class="px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold transition-all bg-white text-blue-600 shadow-sm" onclick="setOffsetMode('optimal')" id="btn-optimal">Auto</button>
            </div>
            
            <div id="growthExponentDiv" class="text-slate-600"></div>
            <div id="modelFitDiv" class="flex items-center text-slate-600"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-3 px-4 text-center space-y-1 w-full">
        <p class="text-slate-500 text-[10px] mx-auto leading-relaxed"><span class="font-sans">&copy;</span> 2025 taotensorlaw.com. Disclaimer: This content is for informational and research purposes only, reflects the author's opinion, and is not financial, investment or trading advice. The cryptocurrency market is volatile; invest at your own risk and only what you can afford to lose. Past performance does not guarantee future results.</p>
    </footer>


    <script>
        /*
         * TAO Tensor Law Model — by decodejar
         * Copyright (c) 2025 taotensorlaw.com. All Rights Reserved.
         */

        // --- SECTION: GLOBAL ELEMENT REFERENCES ---
        const mainContainer = document.getElementById('mainContainer');
        const headerElement = document.querySelector('header');
        const topBarElement = document.getElementById('topStatusBar');
        const bottomBarElement = document.getElementById('bottomModelBar');
        const chartCardElement = document.getElementById('chartCard');
        const fsIconEnter = document.getElementById('fsIconEnter');
        const fsIconExit = document.getElementById('fsIconExit');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const growthExponentDiv = document.getElementById('growthExponentDiv');
        const modelFitDiv = document.getElementById('modelFitDiv');
        const loader = document.getElementById('loader');
        const dataStatusDiv = document.getElementById('dataStatusDiv');
        const lastPriceDiv = document.getElementById('lastPriceDiv');
        const priceZoneDiv = document.getElementById('priceZoneDiv');
        const ctx = document.getElementById('powerLawChart').getContext('2d');
        const modelParamDiv = document.getElementById('modelParamDiv');
        const showBandsContainer = document.getElementById('showBandsContainer');
        const showBandsCheckbox = document.getElementById('showBandsCheckbox');
        const projectionTable = document.getElementById('projectionTable');
        const projectionData = document.getElementById('projectionData');
        const bandLevelsTable = document.getElementById('bandLevelsTable');
        
        // New buttons
        const btn74 = document.getElementById('btn-74');
        const btn232 = document.getElementById('btn-232');
        const btnOptimal = document.getElementById('btn-optimal');

        // --- SECTION: CHART CONFIGURATION & CONSTANTS ---

        const HARDCODED_OFFSET_1 = 74;
        const HARDCODED_OFFSET_2 = 232;
        const MAX_OFFSET_SEARCH_LIMIT = 730;      
        const X_AXIS_PROJECTION_PADDING = 0.33; 
        const Y_AXIS_BOTTOM_PADDING = 0.1;
        const Y_AXIS_TOP_PADDING_MIN = 0.1;
        const Y_AXIS_TOP_PADDING_MAX = 0.33;
        
        let chart; 
        let baseData = []; 
        let priceData = []; 
        let activeModelParams = {}; 
        let currentOffsetMode = 'optimal'; // '74', '232', 'optimal'
        
        // Zoom & Pan State
        let originalExtendedMinDay = 1;
        let originalExtendedMaxDay = 1000;
        const ZOOM_FACTOR = 0.1;
        let isPanning = false;
        let panStartX = 0;
        let panStartMin = 0;
        let panStartLogRange = 0;

        // Band Fill Colors
        const blueFillColor = 'rgba(96, 165, 250, 0.15)';  // Blue-400
        const greenFillColor = 'rgba(74, 222, 128, 0.15)'; // Green-400
        const yellowFillColor = 'rgba(250, 204, 21, 0.15)'; // Yellow-400
        const redFillColor = 'rgba(248, 113, 113, 0.15)';   // Red-400

        // Reusable Line Styles
        const grayLineStyle = { borderColor: 'rgba(148, 163, 184, 0.7)', borderWidth: 1, borderDash: [] }; // Slate-400
        const orangeLineStyle = { borderColor: '#f97316', borderWidth: 2, borderDash: [] }; // Orange-500
        const grayDashedLineStyle = { borderColor: 'rgba(148, 163, 184, 0.9)', borderWidth: 1, borderDash: [4, 4] };
        const grayFineLineStyle = { borderColor: 'rgba(203, 213, 225, 0.8)', borderWidth: 0.5, borderDash: [] }; // Slate-300

        /**
         * Chart.js plugin to add a watermark to the background.
         */
        const watermarkPlugin = {
            id: 'watermark',
            afterDraw: (chart, args, options) => {
                const { ctx, chartArea: { top, right, bottom, left, width, height } } = chart;
                
                if (width <= 0 || height <= 0) return; 

                ctx.save();
                const text = 'taotensorlaw.com';
                
                const baseFontSize = Math.max(30, Math.min(80, width / 12)); 
                ctx.font = `bold ${baseFontSize.toFixed(0)}px Inter, sans-serif`;
                ctx.fillStyle = 'rgba(15, 23, 42, 0.075)'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const centerX = left + width / 2;
                const centerY = top + height / 2;
                ctx.fillText(text, centerX, centerY);
                
                ctx.restore();
            }
        };
        Chart.register(watermarkPlugin);

        // --- SECTION: DATA & REGRESSION LOGIC ---

        async function loadPriceData() {
            try {
                // In a production environment, this path might need adjustment based on where 'price_data.json' is hosted.
                const response = await fetch(`./price_data.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Failed to load data file: ${response.statusText}`);
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error("Invalid data format in JSON file");
                // Assuming data is in format [[timestamp_s, price], ...]
                baseData = data.map((p, i) => ({ time: p[0] * 1000, dayIndex: i + 1, y: p[1] })).filter(p => p.y > 0);
                return baseData;
            } catch (error) {
                console.error("Error loading price data:", error);
                dataStatusDiv.innerHTML = `<span class="status-dot bg-red-500"></span><strong>Updated:</strong>&nbsp;N/A (Error)`;
                loader.style.display = 'none';
                return null;
            }
        }

        function linearRegression(data) {
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            const validData = data.filter(p => p.y > 0 && p.x > 0);
            const n = validData.length;
            if (n < 2) return { slope: 0, intercept: 0 }; 
            
            for (const { x, y } of validData) {
                const logX = Math.log10(x);
                const logY = Math.log10(y);
                sumX += logX; sumY += logY; sumXY += logX * logY; sumX2 += logX * logX;
            }

            const denominator = (n * sumX2 - sumX * sumX);
            if (denominator === 0) return { slope: 0, intercept: 0 }; 
            
            const slope = (n * sumXY - sumX * sumY) / denominator;
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept };
        }

        function calculateResiduals(data, slope, intercept) {
            const validData = data.filter(p => p.y > 0 && p.x > 0);
            if (validData.length === 0) return [];
            return validData.map(p => {
                const logX = Math.log10(p.x);
                const logY = Math.log10(p.y);
                const predictedLogY = slope * logX + intercept;
                return logY - predictedLogY;
            }).sort((a, b) => a - b); 
        }

        function getPercentile(sortedResiduals, percentile) {
            if (!sortedResiduals || sortedResiduals.length === 0) return 0;
            const index = (percentile / 100) * (sortedResiduals.length - 1);
            const lowerIndex = Math.floor(index);
            const upperIndex = Math.ceil(index);
            
            if (lowerIndex === upperIndex) {
                return sortedResiduals[lowerIndex];
            } else {
                const weight = index - lowerIndex;
                return sortedResiduals[lowerIndex] * (1 - weight) + sortedResiduals[upperIndex] * weight;
            }
        }

        function findOptimalOffset(baseData, minOffset = 1, maxOffset) {
            let bestOffset = -1;
            let bestRSquared = -Infinity;

            if (baseData.length < 2) return { optimalOffset: -1, bestFit: 0 };
            if (typeof maxOffset === 'undefined' || maxOffset < minOffset) maxOffset = baseData.length; 

            for (let offset = minOffset; offset <= maxOffset; offset++) {
                const offsetData = baseData.map(p => ({ x: p.dayIndex + offset, y: p.y }));
                const { slope, intercept } = linearRegression(offsetData);
                if (slope === 0 && intercept === 0 && offsetData.length > 1) continue; 
                
                const rSquared = calculateRSquared(offsetData, slope, intercept);
                if (rSquared > bestRSquared) {
                    bestRSquared = rSquared;
                    bestOffset = offset;
                }
            }
            return { optimalOffset: bestOffset, bestFit: bestRSquared };
        }

        function calculateRSquared(data, slope, intercept) {
            let ss_tot = 0, ss_res = 0, y_mean = 0;
            const validData = data.filter(p => p.y > 0 && p.x > 0);
            if (validData.length < 2) return 0;

            validData.forEach(p => y_mean += Math.log10(p.y));
            y_mean /= validData.length;

            validData.forEach(p => {
                const logY = Math.log10(p.y);
                const logX = Math.log10(p.x);
                const predictedLogY = slope * logX + intercept;
                ss_tot += Math.pow(logY - y_mean, 2);
                ss_res += Math.pow(logY - predictedLogY, 2);
            });
            return ss_tot === 0 ? 1 : Math.max(0, 1 - (ss_res / ss_tot)); 
        }


        // --- SECTION: CORE APPLICATION LOGIC ---

        function setOffsetMode(mode) {
            currentOffsetMode = mode;
            
            // Update button styles
            // UPDATED: changed text-indigo-600 to text-blue-600
            const activeClass = "bg-white text-blue-600 shadow-sm";
            const inactiveClass = "text-slate-500 hover:text-slate-700 hover:bg-white/50";
            
            // Reset all
            [btn74, btn232, btnOptimal].forEach(btn => {
                btn.className = `px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold transition-all ${inactiveClass}`;
            });
            
            // Set active
            let activeBtn;
            if(mode === '74') activeBtn = btn74;
            else if(mode === '232') activeBtn = btn232;
            else activeBtn = btnOptimal;
            
            activeBtn.className = `px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold transition-all ${activeClass}`;
            
            createOrUpdateChart();
        }

        async function createOrUpdateChart() {
            loader.style.display = 'flex';
            
            if (baseData.length === 0) {
                await loadPriceData();
            }

            if (!baseData || baseData.length === 0) {
                if (!dataStatusDiv.innerHTML.includes('Error') && !dataStatusDiv.innerHTML.includes('Demo')) { 
                    dataStatusDiv.innerHTML = `<span class="status-dot bg-red-500"></span><strong>Updated:</strong>&nbsp;N/A`;
                }
                growthExponentDiv.innerHTML = '<strong>Exponent (α):</strong> N/A';
                modelParamDiv.innerHTML = '<strong>Day Offset:</strong> N/A';
                modelFitDiv.innerHTML = '<strong>Fit (R²):</strong> N/A';
                showBandsContainer.classList.add('hidden');
                loader.style.display = 'none';
                return;
            }

            let slope, meanIntercept, rSquared;
            let activeDayOffset;
            
            // Find optimal first as we might display it in text even if not selected
            const { optimalOffset, bestFit: optimalOffsetRSquared } = findOptimalOffset(baseData, 1, MAX_OFFSET_SEARCH_LIMIT);
            
            if (currentOffsetMode === 'optimal') {
                activeDayOffset = optimalOffset;
                priceData = baseData.map(p => ({ ...p, x: p.dayIndex + optimalOffset }));
                const regression = linearRegression(priceData);
                slope = regression.slope;
                meanIntercept = regression.intercept;
                rSquared = optimalOffsetRSquared; 
                modelParamDiv.innerHTML = `Day Offset: <span class="font-bold font-mono text-slate-800">${optimalOffset}</span>`;
            } else {
                const fixedOffset = (currentOffsetMode === '74') ? HARDCODED_OFFSET_1 : HARDCODED_OFFSET_2;
                activeDayOffset = fixedOffset;
                priceData = baseData.map(p => ({ ...p, x: p.dayIndex + fixedOffset }));
                const regression = linearRegression(priceData);
                slope = regression.slope;
                meanIntercept = regression.intercept;
                rSquared = calculateRSquared(priceData, slope, meanIntercept);
                
                // Display format: Fixed only (Opt part removed as requested)
                modelParamDiv.innerHTML = `Day Offset: <span class="font-bold font-mono text-slate-800">${fixedOffset}</span>`;
            }
            
            activeModelParams = {
                modelType: currentOffsetMode,
                activeDayOffset: activeDayOffset,
                slope: slope,
                meanIntercept: meanIntercept
            };
            
            const lastBaseDataPoint = baseData[baseData.length - 1]; 
            const lastTimestamp = lastBaseDataPoint.time; 
            const lastUpdateDate = new Date(lastTimestamp).toLocaleDateString(undefined, {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            const now = new Date().getTime();
            const diffMs = now - lastTimestamp;
            const oneDayMs = 24 * 60 * 60 * 1000;
            const sevenDaysMs = 7 * oneDayMs;

            let dotColor = "bg-red-500"; 
            if (diffMs < oneDayMs) {
                dotColor = "bg-green-500"; 
            } else if (diffMs < sevenDaysMs) {
                dotColor = "bg-yellow-400"; 
            }
            
            if(!dataStatusDiv.innerHTML.includes("Demo")) {
                dataStatusDiv.innerHTML = `<span class="status-dot ${dotColor}"></span><span class="font-
