<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAO Tensor Law — Bittensor Price Model — by decodejar</title>
    
    <link rel="icon" href="/decode-favicon.png" type="image/png">
    <link rel="shortcut icon" href="/decode-favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/decode-favicon.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "WebApplication",
          "@id": "https://taotensorlaw.com/#software",
          "name": "TAO Tensor Law",
          "url": "https://taotensorlaw.com/",
          "applicationCategory": "FinanceApplication",
          "operatingSystem": "Web",
          "author": {
            "@id": "https://decodejar.com/#organization"
          }
        }
      ]
    }
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXV4MXZNHJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-EXV4MXZNHJ');
    </script>    

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Courgette&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'md': '800px' },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        handwriting: ['Courgette', 'cursive'],
                        mono: ['JetBrains Mono', 'monospace'], 
                    },
                    colors: { slate: { 850: '#1e293b' } },
                    boxShadow: { 'glass': '0 4px 30px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            background-image: radial-gradient(at 0% 0%, hsla(215,30%,15%,0) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(200,50%,25%,0) 0, transparent 50%);
        }
        
        .loader {
            border: 3px solid rgba(226, 232, 240, 0.3);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

        body:has(#mainContainer:fullscreen) { display: block; background: white; }
        #mainContainer:fullscreen {
            width: 100vw; height: 100vh;
            max-width: none !important; min-height: 0 !important;
            border-radius: 0 !important; border: none !important;
            display: flex; flex-direction: column; padding: 0 !important;
            background: white;
        }
        #mainContainer:fullscreen #chartCard { flex-grow: 1; display: flex; flex-direction: column; box-shadow: none !important; background: transparent !important; }
        #mainContainer:fullscreen #chartWrapper { height: 100% !important; flex-grow: 1; }
        body:has(#mainContainer:fullscreen) footer { display: none; }

        @media (max-width: 639px) and (orientation: portrait) {
            #mainContainer:fullscreen #rotateOverlay { display: flex !important; }
            #mainContainer:fullscreen header, #mainContainer:fullscreen #topStatusBar, #mainContainer:fullscreen #chartCard, #mainContainer:fullscreen #bottomModelBar, #mainContainer:fullscreen #fullscreenBtn { display: none !important; }
        }

        #mainContainer.mobile-fullscreen-landscape { padding: 0 !important; }
        #mainContainer.mobile-fullscreen-landscape #bottomModelBar { display: none !important; }
        #mainContainer.mobile-fullscreen-landscape #chartCard { padding-top: 0 !important; padding-bottom: 0.25rem !important; }
        #mainContainer.mobile-fullscreen-landscape header { height: 2.5rem !important; margin-bottom: 0 !important; }

        #projectionTable, #bandLevelsTable {
            position: absolute; z-index: 20;
            background-color: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 0.75rem; padding: 0.75rem 1rem;
            font-size: 0.75rem; color: #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            width: max-content;
        }
        #projectionTable { top: 12%; left: 2%; }
        #bandLevelsTable { top: 24%; left: 6%; }
        @media (min-width: 800px) {
            #projectionTable { top: 10%; left: 8%; }
            #bandLevelsTable { top: 18%; left: 11%; }
        }
        #projectionTable h3, #bandLevelsTable h3 { font-weight: 600; color: #0f172a; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(203, 213, 225, 0.5); padding-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    </style>
</head>
<body class="text-slate-800 flex flex-col items-center h-screen p-3 sm:p-4 md:px-6 md:pt-6 md:pb-2 overflow-y-auto bg-slate-200">

    <div class="sr-only">
        TAO Tensor Law is a Bittensor price model. This interactive chart models the price history of TAO against a logarithmic power law regression. Fair value trend line and price rating bands help visualize TAO's historical valuation. Created by decodejar.
    </div>

    <div id="mainContainer" class="w-full flex-1 min-h-[600px] max-w-[1920px] max-h-[1080px] flex flex-col bg-white/80 backdrop-blur-xl rounded-2xl border border-white/50 shadow-2xl shadow-slate-400/30 relative overflow-hidden transition-all duration-300">

        <div id="rotateOverlay" class="hidden absolute inset-0 w-full h-full bg-white/95 z-50 flex-col items-center justify-center text-center p-8 backdrop-blur-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-blue-500 mb-4 animate-pulse">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Please Rotate Device</h2>
            <button onclick="toggleFullScreen()" class="mt-6 px-4 py-2 bg-white border border-slate-200 text-blue-600 font-semibold rounded-lg shadow-md hover:bg-slate-50">Cancel</button>
        </div>

        <header class="relative h-14 sm:h-16 flex items-center justify-between px-4 sm:px-6 border-b border-slate-100 bg-white z-50">
            <div class="flex items-center">
                <a href="https://decodejar.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 group">
                    <img src="decode.png" alt="decodejar" class="w-8 h-8 rounded-full border-2 border-white" onerror="this.src='https://placehold.co/40x40/eeeeee/333333?text=D'; this.onerror=null;">
                    <span class="hidden sm:block font-sans font-bold text-black text-lg group-hover:text-blue-600">decodejar</span>
                </a>
            </div>

            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center gap-2">
                <h1 class="text-lg md:text-2xl font-semibold text-black tracking-tight whitespace-nowrap">
                    TAO Tensor Law
                    <span class="hidden sm:inline ml-1 sm:text-sm md:text-lg text-blue-500/80 font-handwriting">Bittensor Price Model</span>
                </h1>
                <div class="group relative flex items-center">
                      <span class="text-[10px] font-bold text-slate-400 cursor-help border border-slate-300 rounded-full w-4 h-4 flex items-center justify-center hover:bg-slate-100 transition-colors">?</span>
                      <div class="absolute top-6 left-1/2 -translate-x-1/2 w-72 bg-slate-800 text-white text-xs rounded-lg p-3 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 shadow-xl z-50 font-light leading-relaxed">
                        TAO Tensor Law is a Bittensor price model visualizing historical valuation via logarithmic power law regression.
                      </div>
                </div>
            </div>

            <div class="flex items-center">
                <button id="snapshotBtn" onclick="copyChartToClipboard()" class="text-slate-400 hover:text-blue-600 p-2 rounded-lg mr-1" title="Copy Chart Image">
                    <span id="snapIconDefault">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                        </svg>
                    </span>
                    <span id="snapIconSuccess" class="hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-green-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </span>
                </button>
                <button id="fullscreenBtn" onclick="toggleFullScreen()" class="text-slate-400 hover:text-blue-600 p-2 rounded-lg" title="Toggle Fullscreen">
                    <svg id="fsIconEnter" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m4.5 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                    </svg>
                    <svg id="fsIconExit" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 hidden">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 9L3.75 3.75M9 9h4.5m-4.5 0v4.5m0-4.5L3.75 3.75M9 15l-5.25 5.25M9 15h4.5m-4.5 0v-4.5m0 4.5l-5.25 5.25M15 9l5.25-5.25M15 9h-4.5m4.5 0v-4.5m0-4.5l5.25-5.25M15 15l5.25 5.25M15 15h-4.5m4.5 0v-4.5m0 4.5l5.25 5.25" />
                    </svg>
                </button>
            </div>
        </header>

        <div id="topStatusBar" class="flex flex-wrap items-center justify-center sm:justify-between gap-x-4 gap-y-2 px-4 sm:px-6 py-2 md:py-3 border-b border-slate-100 bg-slate-50">
             <div class="flex items-center gap-6 text-xs md:text-sm font-medium text-slate-600">
                 <div id="dataStatusDiv" class="flex items-center">
                     <span class="status-dot bg-green-500 animate-pulse"></span><span class="text-slate-400">Loading</span>
                 </div>
                 <div id="lastPriceDiv" class="hidden sm:flex items-center text-slate-700 font-mono"></div>
             </div>
             
             <div class="flex items-center gap-4 text-xs md:text-sm">
                 <div id="priceZoneDiv" class="hidden sm:flex items-center bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm"></div>
                 <div id="showBandsContainer" class="flex items-center hidden group">
                     <label for="showBandsCheckbox" class="flex items-center cursor-pointer select-none">
                          <span class="mr-3 text-xs md:text-sm font-medium text-slate-700 group-hover:text-blue-600">Show Bands</span>
                          <div class="relative">
                             <input type="checkbox" id="showBandsCheckbox" class="peer sr-only">
                             <div class="block h-6 w-10 rounded-full bg-slate-200 peer-checked:bg-blue-500"></div>
                             <div class="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition-transform peer-checked:translate-x-4"></div>
                          </div>
                     </label>
                 </div>
             </div>
        </div>

        <div id="chartCard" class="relative flex-grow min-h-0 w-full px-4 sm:px-6 pb-4 bg-white">
            <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col gap-3 items-center justify-center z-30 transition-opacity duration-300">
                <div class="loader"></div>
                <p class="text-xs text-slate-400 animate-pulse uppercase tracking-widest">Initialising Model</p>
            </div>
            
            <div id="chartWrapper" class="relative w-full h-full bg-white">
                <div id="projectionTable" class="hidden">
                    <h3 id="projectionHeader" class="text-xs md:text-sm">
                        <span>Fair Value</span>
                        <button onclick="document.getElementById('projectionTable').style.display='none'" type="button" title="Close">✕</button>
                    </h3>
                    <div id="projectionData" class="flex flex-col pt-1"></div>
                </div>

                <div id="bandLevelsTable" class="hidden">
                    <h3 id="bandsHeader" class="text-xs md:text-sm">
                        <span>Valuation Bands</span>
                        <button onclick="document.getElementById('bandLevelsTable').style.display='none'" type="button" title="Close">✕</button>
                    </h3>
                    <div class="flex flex-col pt-1">
                        <div id="bandLevelBubble" class="flex justify-between gap-8 py-0.5">
                            <span class="inline-flex items-center text-xs text-slate-500"><span class="w-2 h-2 rounded-full bg-red-400 mr-2"></span>Bubble</span>
                            <span class="font-mono text-slate-700"></span>
                        </div>
                        <div id="bandLevelExpensive" class="flex justify-between gap-8 py-0.5">
                            <span class="inline-flex items-center text-xs text-slate-500"><span class="w-2 h-2 rounded-full bg-yellow-400 mr-2"></span>Expensive</span>
                            <span class="font-mono text-slate-700"></span>
                        </div>
                        <div id="bandLevelValue" class="flex justify-between gap-8 py-0.5">
                            <span class="inline-flex items-center text-xs text-slate-500"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>Value</span>
                            <span class="font-mono text-slate-700"></span>
                        </div>
                        <div id="bandLevelDiscount" class="flex justify-between gap-8 py-0.5">
                            <span class="inline-flex items-center text-xs text-slate-500"><span class="w-2 h-2 rounded-full bg-blue-400 mr-2"></span>Discount</span>
                            <span class="font-mono text-slate-700"></span>
                        </div>
                    </div>
                </div>
                
                <canvas id="powerLawChart"></canvas>
            </div>
        </div>

        <div id="bottomModelBar" class="bg-slate-50 border-t border-slate-100 px-4 sm:px-6 py-2 md:py-3 flex flex-wrap items-center justify-center gap-x-6 gap-y-2 text-xs md:text-sm font-medium text-slate-500">
            <div class="flex items-center group">
                 <label for="linearTimeCheckbox" class="flex items-center cursor-pointer select-none">
                      <span class="mr-3 text-slate-600 group-hover:text-blue-600">Log-Linear</span>
                      <div class="relative">
                          <input type="checkbox" id="linearTimeCheckbox" class="peer sr-only">
                          <div class="block h-6 w-10 rounded-full bg-slate-200 peer-checked:bg-blue-500"></div>
                          <div class="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition-transform peer-checked:translate-x-4"></div>
                      </div>
                 </label>
            </div>
            <div class="flex items-center group">
                 <label for="autoFitCheckbox" class="flex items-center cursor-pointer select-none">
                      <span class="mr-3 text-slate-600 group-hover:text-blue-600">Auto-Fit</span>
                      <div class="relative">
                          <input type="checkbox" id="autoFitCheckbox" class="peer sr-only">
                          <div class="block h-6 w-10 rounded-full bg-slate-200 peer-checked:bg-blue-500"></div>
                          <div class="absolute left-1 top-1 h-4 w-4 rounded-full bg-white transition-transform peer-checked:translate-x-4"></div>
                      </div>
                 </label>
            </div>
            <div id="modelParamDiv" class="text-slate-600"></div>
            <div id="growthExponentDiv" class="text-slate-600"></div>
            <div id="modelFitDiv" class="flex items-center text-slate-600"></div>
        </div>
    </div>

    <footer class="pt-3 pb-0 px-4 text-center w-full">
        <p class="text-slate-500 text-xs leading-relaxed">© 2025 taotensorlaw.com. Disclaimer: Informational only, not financial advice.</p>
    </footer>

    <script>
        const ColorUtils = {
            parseColor: (c) => {
                if (!c || c === 'transparent') return { r:0, g:0, b:0, a:0 };
                if (c.startsWith('#')) {
                    const b = parseInt(c.slice(1), 16);
                    return { r:(b>>16)&255, g:(b>>8)&255, b:b&255, a:1 };
                }
                const p = c.match(/(\d+(\.\d+)?)/g);
                return p ? { r:parseFloat(p[0]), g:parseFloat(p[1]), b:parseFloat(p[2]), a:p[3]?parseFloat(p[3]):1 } : {r:0,g:0,b:0,a:1};
            },
            setAlpha: function(c, a) {
                const o = this.parseColor(c);
                return `rgba(${o.r}, ${o.g}, ${o.b}, ${o.a * a})`;
            }
        };

        const OFFSET_NAKAMOTO = 486; 
        const OFFSET_FINNEY = -17;
        const MAX_OFFSET_SEARCH_LIMIT = 789;        
        const X_AXIS_PROJECTION_PADDING = 0.40; 
        const Y_AXIS_BOTTOM_PADDING = 0.1;
        const Y_AXIS_TOP_PADDING_MAX = 0.40;
        const MODE_N = 'N', MODE_A = 'A';

        let chart, baseData = [], priceData = [], activeModelParams = {}; 
        let currentOffsetMode = MODE_N, isPanning = false, panStartX = 0, panStartMin = 0;
        let originalExtendedMinDay = 1, originalExtendedMaxDay = 1000;
        const ZOOM_FACTOR = 0.1;

        /**
         * PLUGIN: Watermark
         */
        const watermarkPlugin = {
            id: 'watermark',
            afterDraw: (chart) => {
                const { ctx, chartArea: { top, left, width, height } } = chart;
                if (width <= 0 || height <= 0) return;
                ctx.save();
                ctx.font = `bold ${Math.max(30, Math.min(80, width/12))}px Inter`;
                ctx.fillStyle = 'rgba(15, 23, 42, 0.07)';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('taotensorlaw.com', left + width/2, top + height/2);
                ctx.restore();
            }
        };

        /**
         * PLUGIN: Live Price Label on Axis
         * Draws the exact current price label on the Y-Axis area.
         */
        const priceLabelPlugin = {
            id: 'priceLabel',
            afterDraw: (chart) => {
                if (!baseData || baseData.length === 0) return;
                const { ctx, scales: { y, x }, chartArea } = chart;
                const lastPrice = baseData[baseData.length - 1].y;
                const yPixel = y.getPixelForValue(lastPrice);

                // Only draw if within visible range
                if (yPixel < chartArea.top || yPixel > chartArea.bottom) return;

                ctx.save();
                
                const labelText = `$${lastPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                ctx.font = 'bold 11px "JetBrains Mono", monospace';
                const textWidth = ctx.measureText(labelText).width;
                const paddingH = 6;
                const paddingV = 4;
                const rectWidth = textWidth + (paddingH * 2);
                const rectHeight = 18;
                
                // Position label on the axis (left side)
                const xPos = y.left - rectWidth - 2; 
                const yPos = yPixel - (rectHeight / 2);

                // Background Tag
                ctx.fillStyle = '#0f172a'; // Deep slate
                ctx.beginPath();
                if (ctx.roundRect) {
                    ctx.roundRect(xPos, yPos, rectWidth, rectHeight, 4);
                } else {
                    ctx.rect(xPos, yPos, rectWidth, rectHeight);
                }
                ctx.fill();

                // Text
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(labelText, xPos + (rectWidth / 2), yPos + (rectHeight / 2) + 0.5);

                ctx.restore();
            }
        };

        Chart.register(watermarkPlugin, priceLabelPlugin);

        async function loadPriceData() {
            try {
                const response = await fetch(`./price_data.json?t=${Date.now()}`);
                const data = await response.json();
                baseData = data.map((p, i) => ({ time: p[0] * 1000, dayIndex: i + 1, y: p[1] })).filter(p => p.y > 0);
                return baseData;
            } catch (e) {
                document.getElementById('dataStatusDiv').innerHTML = `<span class="status-dot bg-red-500"></span><strong>Load Error</strong>`;
                document.getElementById('loader').style.display = 'none';
                return null;
            }
        }

        function linearRegression(data) {
            let n = data.length, sx = 0, sy = 0, sxy = 0, sx2 = 0;
            for (const { x, y } of data) {
                const lx = Math.log10(x), ly = Math.log10(y);
                sx += lx; sy += ly; sxy += lx * ly; sx2 += lx * lx;
            }
            const den = (n * sx2 - sx * sx);
            if (den === 0) return { slope: 0, intercept: 0 };
            const m = (n * sxy - sx * sy) / den;
            return { slope: m, intercept: (sy - m * sx) / n };
        }

        function calculateRSquared(data, m, b) {
            let st = 0, sr = 0, ym = 0, n = data.length;
            data.forEach(p => ym += Math.log10(p.y)); ym /= n;
            data.forEach(p => {
                const ly = Math.log10(p.y), lx = Math.log10(p.x);
                st += Math.pow(ly - ym, 2);
                sr += Math.pow(ly - (m * lx + b), 2);
            });
            return st === 0 ? 1 : Math.max(0, 1 - (sr / st));
        }

        function findOptimalOffset(data, min, max) {
            let bestO = -1, bestR = -Infinity;
            for (let o = min; o <= max; o++) {
                const d = data.map(p => ({ x: p.dayIndex + o, y: p.y }));
                const { slope: m, intercept: b } = linearRegression(d);
                const r = calculateRSquared(d, m, b);
                if (r > bestR) { bestR = r; bestO = o; }
            }
            return { optimalOffset: bestO, bestFit: bestR };
        }

        async function createOrUpdateChart() {
            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            if (baseData.length === 0) await loadPriceData();
            if (baseData.length === 0) return;

            const isAuto = document.getElementById('autoFitCheckbox').checked;
            const isLinear = document.getElementById('linearTimeCheckbox').checked;
            currentOffsetMode = isAuto ? MODE_A : MODE_N;

            let activeOffset = isAuto ? findOptimalOffset(baseData, OFFSET_FINNEY, MAX_OFFSET_SEARCH_LIMIT).optimalOffset : OFFSET_NAKAMOTO;
            priceData = baseData.map(p => ({ ...p, x: p.dayIndex + activeOffset }));
            const { slope, intercept } = linearRegression(priceData);
            const r2 = calculateRSquared(priceData, slope, intercept);
            activeModelParams = { slope, meanIntercept: intercept, activeDayOffset: activeOffset };

            document.getElementById('modelParamDiv').innerHTML = `Offset: <span class="font-bold font-mono text-slate-800">${isAuto ? activeOffset : 'Nakamoto'}</span>`;
            document.getElementById('growthExponentDiv').innerHTML = `Exponent (α): <span class="font-bold font-mono text-slate-800">${slope.toFixed(3)}</span>`;
            document.getElementById('modelFitDiv').innerHTML = `<span class="status-dot ${r2>0.9?'bg-blue-400':'bg-green-500'}"></span>Fit (R²): <span class="font-bold font-mono text-slate-800 ml-1">${r2.toFixed(4)}</span>`;

            const lastPoint = baseData[baseData.length-1];
            document.getElementById('lastPriceDiv').textContent = `Price: $${lastPoint.y.toFixed(2)}`;
            document.getElementById('lastPriceDiv').classList.remove('hidden');

            // Residuals for bands
            const res = priceData.map(p => Math.log10(p.y) - (slope * Math.log10(p.x) + intercept)).sort((a,b)=>a-b);
            const getP = (arr, p) => arr[Math.floor((p/100)*(arr.length-1))];
            const pMed = getP(res, 50), p1 = getP(res, 1), p99 = getP(res, 99), p20 = getP(res, 20), p80 = getP(res, 80);

            // Price Zone Logic
            const lastRes = Math.log10(lastPoint.y) - (slope * Math.log10(lastPoint.dayIndex + activeOffset) + intercept);
            let zone = "Value", zoneC = "bg-green-500";
            if (lastRes > p80) { zone = "Bubble"; zoneC = "bg-red-500"; }
            else if (lastRes > pMed) { zone = "Expensive"; zoneC = "bg-yellow-400"; }
            else if (lastRes < p20) { zone = "Discount"; zoneC = "bg-blue-400"; }
            document.getElementById('priceZoneDiv').innerHTML = `<span class="status-dot ${zoneC}"></span><span class="font-sans text-slate-600">${zone}</span>`;
            document.getElementById('priceZoneDiv').classList.remove('hidden');

            const lastX = Math.log10(lastPoint.dayIndex + activeOffset);
            const bandVal = (p) => Math.pow(10, slope * lastX + intercept + p).toFixed(2);
            document.querySelector('#bandLevelBubble span:last-child').textContent = `$${bandVal(p80)} - $${bandVal(p99)}`;
            document.querySelector('#bandLevelExpensive span:last-child').textContent = `$${bandVal(pMed)} - $${bandVal(p80)}`;
            document.querySelector('#bandLevelValue span:last-child').textContent = `$${bandVal(p20)} - $${bandVal(pMed)}`;
            document.querySelector('#bandLevelDiscount span:last-child').textContent = `$${bandVal(p1)} - $${bandVal(p20)}`;

            calculateProjections(baseData, activeModelParams, document.getElementById('projectionData'));

            const xMin = priceData[0].x, xMax = priceData[priceData.length-1].x;
            const xRange = isLinear ? (xMax - xMin) : (Math.log10(xMax) - Math.log10(xMin));
            const xExt = isLinear ? xMax + xRange * 0.4 : Math.pow(10, Math.log10(xMax) + xRange * 0.4);
            originalExtendedMinDay = xMin; originalExtendedMaxDay = xExt;

            const yPrices = priceData.map(p => p.y);
            const yMin = Math.min(...yPrices), yMax = Math.max(...yPrices);
            const yLogR = Math.log10(yMax) - Math.log10(yMin);
            const yExtMin = Math.pow(10, Math.log10(yMin) - yLogR * 0.1);
            const yExtMax = Math.pow(10, Math.log10(yMax) + yLogR * 0.4);

            const genLine = (offset) => {
                const pts = []; const steps = isLinear ? 100 : 2;
                const start = xMin, end = xExt;
                for(let i=0; i<=steps; i++) {
                    const cx = start + (i/steps)*(end-start);
                    pts.push({ x: cx, y: Math.pow(10, slope * Math.log10(cx) + intercept + offset) });
                }
                return pts;
            };

            const datasets = [
                { label: 'P1', data: genLine(p1), borderColor: 'transparent', pointRadius:0, fill:false },
                { label: 'Discount', data: genLine(p20), borderColor: 'transparent', backgroundColor: 'rgba(96, 165, 250, 0.15)', fill: 0, pointRadius:0 },
                { label: 'Value', data: genLine(pMed), borderColor: 'transparent', backgroundColor: 'rgba(74, 222, 128, 0.15)', fill: 1, pointRadius:0 },
                { label: 'Expensive', data: genLine(p80), borderColor: 'transparent', backgroundColor: 'rgba(250, 204, 21, 0.15)', fill: 2, pointRadius:0 },
                { label: 'Bubble', data: genLine(p99), borderColor: 'transparent', backgroundColor: 'rgba(248, 113, 113, 0.15)', fill: 3, pointRadius:0 },
                { label: 'Price', data: priceData.map(p=>({x:p.x, y:p.y})), borderColor: '#0f172a', borderWidth: 2, fill:false, pointRadius:0, tension:0.1 },
                { label: 'Fair Value', data: genLine(pMed), borderColor: '#f97316', borderWidth: 2, fill:false, pointRadius:0 },
                { label: 'Boundary Low', data: genLine(p1), borderColor: 'rgba(148, 163, 184, 0.7)', borderDash:[5,5], fill:false, pointRadius:0 },
                { label: 'Boundary High', data: genLine(p99), borderColor: 'rgba(148, 163, 184, 0.7)', borderDash:[5,5], fill:false, pointRadius:0 }
            ];

            if (chart) {
                chart.options.scales.x.type = isLinear ? 'linear' : 'logarithmic';
                chart.options.scales.x.min = xMin; chart.options.scales.x.max = xExt;
                chart.options.scales.y.min = yExtMin; chart.options.scales.y.max = yExtMax;
                chart.data.datasets.forEach((d, i) => { if(datasets[i]) Object.assign(d, datasets[i]); });
                applyBandVisibility(document.getElementById('showBandsCheckbox').checked);
                chart.update();
            } else {
                chart = new Chart(document.getElementById('powerLawChart').getContext('2d'), {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { 
                            legend: { labels: { filter: (item) => [5,6,7,8].includes(item.datasetIndex) } },
                            tooltip: { mode: 'index', intersect: false, filter: (item) => item.datasetIndex === 5 }
                        },
                        scales: {
                            x: { type: isLinear ? 'linear' : 'logarithmic', min: xMin, max: xExt, grid: { color: 'rgba(0,0,0,0.03)' } },
                            y: { type: 'logarithmic', min: yExtMin, max: yExtMax, grid: { color: 'rgba(0,0,0,0.03)' },
                                 ticks: { callback: (v) => Math.log10(v) % 1 === 0 ? `$${v.toLocaleString()}` : '' }
                            }
                        }
                    }
                });
                applyBandVisibility(false);
            }
            loader.style.display = 'none';
        }

        function applyBandVisibility(show) {
            if(!chart) return;
            [0,1,2,3,4].forEach(i => chart.setDatasetVisibility(i, show));
            chart.update();
            document.getElementById('bandLevelsTable').style.display = show ? 'block' : 'none';
        }

        function calculateProjections(data, params, el) {
            const { slope, meanIntercept, activeDayOffset } = params;
            const startD = new Date(data[0].time);
            const years = [new Date(), new Date(new Date().getFullYear()+1,0,1), new Date(new Date().getFullYear()+2,0,1)];
            el.innerHTML = years.map(d => {
                const diff = Math.round((d - startD)/(1000*60*60*24)) + 1 + activeDayOffset;
                const p = Math.pow(10, slope * Math.log10(diff) + meanIntercept);
                return `<div class="flex justify-between gap-4"><span>${d.getFullYear() === new Date().getFullYear() ? 'Today' : d.getFullYear()}</span><span class="font-mono">$${p.toFixed(2)}</span></div>`;
            }).join('');
        }

        async function copyChartToClipboard() {
            const canvas = document.getElementById('powerLawChart');
            const temp = document.createElement('canvas');
            temp.width = canvas.width; temp.height = canvas.height;
            const tctx = temp.getContext('2d');
            tctx.fillStyle = '#fff'; tctx.fillRect(0,0,temp.width,temp.height);
            tctx.drawImage(canvas, 0, 0);
            temp.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                const def = document.getElementById('snapIconDefault'), suc = document.getElementById('snapIconSuccess');
                def.classList.add('hidden'); suc.classList.remove('hidden');
                setTimeout(() => { def.classList.remove('hidden'); suc.classList.add('hidden'); }, 2000);
            });
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.getElementById('mainContainer').requestFullscreen();
            else document.exitFullscreen();
        }

        window.onload = () => {
            document.getElementById('autoFitCheckbox').addEventListener('change', createOrUpdateChart);
            document.getElementById('linearTimeCheckbox').addEventListener('change', createOrUpdateChart);
            document.getElementById('showBandsCheckbox').addEventListener('change', (e) => applyBandVisibility(e.target.checked));
            createOrUpdateChart();
        };
    </script>
</body>
</html>
